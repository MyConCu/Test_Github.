SELECT DISTINCT CASE_KEY, CARER_KEY, PLACEMENT_ID, END_DATE, 
  NVL(ACTUAL_END_DATE, END_DATE) AS PLMT_END_DATE,
  RANK() OVER(PARTITION BY CARER_KEY 
        ORDER BY  CASE WHEN EVENT_TYPE = 'PLME' THEN 1 
                      WHEN EVENT_TYPE = 'PLMM' THEN 2 ELSE 3
                  END, ACTUAL_END_DATE DESC) AS Latest_Rank
FROM ( SELECT DISTINCT CASE_KEY, REG_MEMBER.CARER_KEY, PLACEMENT_ID, END_DATE, EVENT_TYPE,
          CASE WHEN EVENT_TYPE = 'PLME' THEN ACTUAL_END_DATE END AS ACTUAL_END_DATE
      FROM INT_OOHC_PLACEMENTS_FIN OOHC
          INNER JOIN TRN_CARER_REG_MEMBER REG_MEMBER
          ON OOHC.CARER_REG_ID = REG_MEMBER.REG_ID                                    
      WHERE YEAR_MONTH BETWEEN 201810 AND 201911
          AND EVENT_TYPE IN ('PLMS', 'PLMM', 'PLME')
          AND REG_MEMBER.ETL_DATA_STATUS_ID <> 0 
          AND CARE_TYPE = 'STITCHIO';
